<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="utf-8">
        <title>Project 3</title>
        <style>
            @import url('https://fonts.googleapis.com/css?family=Do+Hyeon');

            body
            {
                text-align: center;
            }

            h1
            {
                font-size: 64pt;
            }

            h1, h2
            {
                font-family: "Do Hyeon", sans-serif;
            }
        </style>

        <!-- Import jQuery -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>

        <script>

            var GB_URL = "https://www.giantbomb.com/api/search/?json_callback=gbSearch&format=jsonp&api_key=";
            var GB_KEY = "f57d683377deb02159063a9618aaef708731316e";

            var YT_URL = "https://www.googleapis.com/youtube/v3/search/?callback=ytSearch&part=snippet&type=video&key=";
            var YT_KEY = "AIzaSyDrxICMCNru0ijt36QbU0fHkQ7AuVzfwOY";

            var value;
            window.onload = init;
            
            function init(){
                document.querySelector("#search").onclick = getData;
            }
            
            // MY FUNCTIONS
            function getData(){
                // build up our URL string
                var url = GB_URL;
                url += GB_KEY;

                value = document.querySelector("#searchterm").value;
                
                // get rid of any leading and trailing spaces
                value = value.trim();
                
                // if there's no band to search then bail out of the function
                if(value.length < 1) return;
                
                //document.querySelector("#dynamicContent").innerHTML = "<b>Searching for " + value + "</b>";
                
                // replace spaces the user typed in the middle of the term with %20
                // %20 is the hexadecimal value for a space
                value = encodeURI(value); 
                
                // finally, add the artist name to the end of the string
                url += "&query=" + value;
                
                // call the web service, and download the file
                console.log("loading " + url);
                $.ajax({
                dataType: "jsonp",
                url: url,
                data: null,
                success: gbSearch
                });
            }
            
            // TODO: Follow D.R.Y!
            function getData2(){
                // build up our URL string
                var url = YT_URL;
                url += YT_KEY;

                //value = document.querySelector("#searchterm").value;

                value = this.name;
                
                // get rid of any leading and trailing spaces
                value = value.trim();
                
                // if there's no band to search then bail out of the function
                if(value.length < 1) return;
                
                // replace spaces the user typed in the middle of the term with %20
                // %20 is the hexadecimal value for a space
                value = encodeURI(value); 
                
                // finally, add the artist name to the end of the string
                url += "&q=" + value + encodeURI(" Let's Play");
                
                // call the web service, and download the file
                console.log("loading " + url);
                $.ajax({
                dataType: "jsonp",
                url: url,
                data: null,
                success: ytSearch
                });
            }
            
            function gbSearch(obj){
                console.dir(obj);
                console.log("obj = " + obj);
                console.log("obj stringified = " + JSON.stringify(obj));

                var myContent = document.querySelector("#content");
                myContent.innerHTML = "";
                
                // if there's an error, print a message and return
                if(obj.status_code != 1){
                    var status = obj.status_code;
                    var error = obj.error;
                    myContent.innerHTML = "<h3><b>Error!</b></h3>" + "<p><i>" + status + "</i><p>" + "<p><i>" + error + "</i><p>";
                    return; // Bail out
                }
                
                // if there are no results, print a message and return
                if(obj.results.length == 0){
                    var status = "No results found";
                    myContent.innerHTML = "<p><i>" + status + "</i><p>" + "<p><i>";
                    return; // Bail out
                }
                
                // TODO
                // if there is only one result, Eventful returns an object instead of an array
                // create an array with the single object
                
                // If there is an array of results, loop through them
                var allGames = obj.results;
                console.log("allGames.length = " + allGames.length);

                var pElem = document.createElement("p");
                var bElem = document.createElement("b");

                bElem.innerHTML = obj.number_of_page_results + " out of " + obj.number_of_total_results + " results for '" + decodeURI(value) + "'";
                pElem.appendChild(bElem);
                myContent.appendChild(pElem);

                myContent.appendChild(document.createElement("hr"));
                
                // loop through events here
                for(var i = 0; i < allGames.length; i++){
                    if(allGames[i].resource_type != "game"){
                        continue;
                    }

                    pElem = document.createElement("p");
                    bElem = document.createElement("b");

                    if(allGames[i].name != null){
                        bElem.innerHTML = allGames[i].name;
                    }
                    else{
                        bElem.innerHTML = "(Error: Name not found)";
                    }

                    pElem.appendChild(bElem);
                    myContent.appendChild(pElem);

                    if(allGames[i].image != null){
                        var imgElem = document.createElement("img");
                        imgElem.setAttribute("src", allGames[i].image.thumb_url);
                        myContent.appendChild(imgElem);
                    }

                    if(allGames[i].deck != null){
                        pElem = document.createElement("p");
                        pElem.innerHTML += allGames[i].deck;
                        myContent.appendChild(pElem);
                    }

                    /*if(allGames[i].developers != null){
                        myContent.innerHTML += "<p><b>Developed by ";

                        for(var j = 0; j < allGames[i].developers.length; j++){
                            if(j == allGames[i].developers.length - 1){
                                myContent.innerHTML += "and ";
                            }

                            myContent.innerHTML += allGames[i].developers[j];

                            if(j != allGames[i].developers.length - 1){
                                myContent.innerHTML += ", ";
                            }
                        }

                        myContent.innerHTML += "</b></p>";
                    }
                    else{
                        myContent.innerHTML += "<p><b>Developed by some team</b></p>";
                    }*/

                    pElem = document.createElement("p");
                    bElem = document.createElement("b");

                    if(allGames[i].original_release_date != null){
                        bElem.innerHTML += "Released on " + parseDate(allGames[i].original_release_date);
                    }
                    /*else{
                        myContent.innerHTML += "<p><b>Released on some date</b></p>";
                    }*/

                    pElem.appendChild(bElem);
                    myContent.appendChild(pElem);

                    if(allGames[i].site_detail_url != null){
                        var aElem = document.createElement("a");
                        aElem.setAttribute("href", allGames[i].site_detail_url);
                        aElem.innerHTML = "Link to game's GiantBomb page";
                        myContent.appendChild(aElem);
                    }

                    var myButton = document.createElement("input");
                    myButton.type = "button";
                    myButton.value = "Find a Let's Play!";

                    pElem = document.createElement("p");
                    pElem.appendChild(myButton);

                    myContent.appendChild(pElem);

                    myButton.onclick = getData2.bind(allGames[i]);

                    myContent.appendChild(document.createElement("hr"));
                }
            }

            function ytSearch(obj){
                console.dir(obj);
                console.log("obj = " + obj);
                console.log("obj stringified = " + JSON.stringify(obj));

                var myContent = document.querySelector("#content");
                myContent.innerHTML = "";

                // TODO: How do you detect if the Youtube Data API has thrown an error?
                // if there's an error, print a message and return
                /*if(obj.status_code != 200){
                    var status = obj.status_code;
                    var error = obj.error;
                    document.querySelector("#content").innerHTML = "<h3><b>Error!</b></h3>" + "<p><i>" + status + "</i><p>" + "<p><i>" + error + "</i><p>";
                    return; // Bail out
                }*/
                
                // if there are no results, print a message and return
                if(obj.items.length == 0){
                    var status = "No results found";
                    myContent.innerHTML = "<p><i>" + status + "</i><p>" + "<p><i>";
                    return; // Bail out
                }

                // This is where the fun begins
                var allVideos = obj.items;

                var pElem = document.createElement("p");
                var bElem = document.createElement("b");

                bElem.innerHTML = obj.pageInfo.resultsPerPage + " out of " + obj.pageInfo.totalResults + " results for '" + decodeURI(value) + "'";

                pElem.appendChild(bElem);
                myContent.appendChild(pElem);

                myContent.appendChild(document.createElement("hr"));

                for(var i = 0; i < allVideos.length; i++){
                    pElem = document.createElement("p");
                    bElem = document.createElement("b");

                    if(allVideos[i].snippet.title != null){
                        bElem.innerHTML = allVideos[i].snippet.title;
                    }
                    else{
                        bElem.innerHTML = "Error: Title not found";
                    }

                    pElem.appendChild(bElem);
                    myContent.appendChild(pElem);

                    if(allVideos[i].snippet.thumbnails.high != null && allVideos[i].id.videoId != null){
                        var aElem = document.createElement("a");

                        var imgElem = document.createElement("img");
                        imgElem.setAttribute("src", allVideos[i].snippet.thumbnails.high.url);

                        aElem.appendChild(imgElem);
                        aElem.setAttribute("href", "https://www.youtube.com/watch?v=" + allVideos[i].id.videoId);

                        myContent.appendChild(aElem);
                    }

                    if(allVideos[i].snippet.channelTitle != null && allVideos[i].snippet.channelId != null){
                        pElem = document.createElement("p");
                        var aElem = document.createElement("a");
                        aElem.innerHTML = allVideos[i].snippet.channelTitle;
                        aElem.setAttribute("href", "https://www.youtube.com/channel/" + allVideos[i].snippet.channelId);

                        pElem.appendChild(aElem);
                        myContent.appendChild(pElem);
                    }

                    myContent.appendChild(document.createElement("hr"));
                }
            }

            // Pass in a string, and this will blindly parse out a date!
            function parseDate(date){
                // FORMAT: Year-Month-Day HH:MM:SS (24h)

                // Splits date into the date and time
                var myValues = date.split(" ");
                
                // Splits date into year, month, and day
                myValues[0] = myValues[0].split("-");

                // Splits time into hour, minute, and second
                myValues[1] = myValues[1].split(":");

                // Begin parsing!
                var myString = "";

                // First, the date
                // Figure out the month!
                switch(Number(myValues[0][1])){
                    case 1:
                        myString += "January ";
                        break;
                    
                    case 2:
                        myString += "February ";
                        break;

                    case 3:
                        myString += "March ";
                        break;

                    case 4:
                        myString += "April ";
                        break;

                    case 5:
                        myString += "May ";
                        break;

                    case 6:
                        myString += "June ";
                        break;

                    case 7:
                        myString += "July ";
                        break;

                    case 8:
                        myString += "August ";
                        break;

                    case 9:
                        myString += "September ";
                        break;

                    case 10:
                        myString += "October ";
                        break;

                    case 11:
                        myString += "November ";
                        break;

                    case 12:
                        myString += "December ";
                        break;
                }

                // Figure out which postfix to put on the day!
                myString += Number(myValues[0][2]);
                if(myValues[0][2] == "01" || myValues[0][2] == "21" || myValues[0][2] == "31"){
                    myString += "st, ";
                }
                else if(myValues[0][2] == "02" || myValues[0][2] == "22"){
                    myString += "nd, ";
                }
                else if(myValues[0][2] == "03" || myValues[0][2] == "23"){
                    myString += "rd, ";
                }
                else{
                    myString += "th, ";
                }

                // Then, add the year.
                myString += myValues[0][0];

                return myString;
            }

        </script>
    </head>

    <body>
        <h1>Let's Play Finder</h1>

        <h2>What game do you want to watch?</h2>
        <form>
            <input type="text" id="searchterm" placeholder="Search for a game" />
            <input type="button" id="search" value="Search!" />
        </form>

        <div id="content"></div>
    </body>

</html>